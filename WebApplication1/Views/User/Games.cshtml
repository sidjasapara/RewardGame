@{
    ViewBag.Title = "Games";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@{
    var i = 1;
    if (TempData["balance"] == null)
    {
        i = 0;
    }
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

<link href="~/Content/toastr.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<script src="~/Scripts/toastr.js"></script>

<div class="text-center card container">
    <form method="post">
        @if (i == 0)
        {
            <div class="p-5">
                <h3 class="form-control border-dark" id="prize" style="font-size: 24px">Play to Earn</h3>
                <button id="play" class="btn btn-warning mt-4 px-4 py-1" type="button">Play</button>
            </div>
        }
        else if (i == 1)
        {
            <h3 class="text-danger mt-2" id="heading">Add Some Funds to continue playing</h3>
        }
    </form>
</div>

<div class="container mt-3">
    <h5>Game Rules</h5>
    <ol>
        <li>Only first 3 games after registration are free.</li>
        <li>Playing after that will deduct ₹20 from your current balance.</li>
        <li>Your total earning cannot exceed ₹500 per day.</li>
        <li>If your earning exceeds 500 than reward will not get credited & ₹20 will still be debited!!</li>
    </ol>
</div>

<!-- Modal -->
<div class="modal fade" tabindex="-1" id="confirmationModal" data-bs-backdrop="static" data-bs-keyboard="false" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header text-danger">
                <h5 class="modal-title">₹20 to Play</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>There were only 3 free games!!<br />₹20 will be debited. Are you sure you want to play?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                <button type="button" id="yes" class="btn btn-warning">Play</button>
            </div>
        </div>
    </div>
</div>


<script>
    $("#play").on('click', function () {
        var random = Math.floor(Math.random() * 100) + 1;
        $.ajax({
            type: 'GET',
            url: '@Url.Action("GamesCount", "User")',
            dataType: 'json',
            success: function (data) {
                if (data >= 3) {
                    $('#confirmationModal').modal('show');

                    $("#yes").off('click').on('click', function () {
                        $('#confirmationModal').modal('hide');
                        playGame(random);
                    });
                }
                else if (data < 3) {
                    playGame(random);
                }
            },
            error: function (xhr, status, error) {
                toastr.error("An error occurred: " + error);
            }
        });

        function playGame(random) {
            $.ajax({
                type: 'POST',
                url: '@Url.Action("Games", "User")',
                dataType: 'json',
                data: { reward: random },
                success: async function (data) {
                    if (data == 0) {
                        await performAnimation()
                            .then(res => {
                                toastr.warning("You cannot win more than 500 today! Come back tomorrow.");
                                $("#prize").removeClass("border-dark border-success");
                                $('#prize').text(`${random}`).addClass("text-warning fw-bold border-warning");
                            })
                            .catch(err => {

                            })
                    }
                    else if (data == -1) {
                        toastr.error("Your Balance is not sufficient! Add funds to continue playing.");
                    }
                    else {
                        await performAnimation()
                            .then(res => {
                                $("#prize").removeClass("border-dark border-warning text-warning");
                                $('#prize').text(`${random}`).addClass("text-success fw-bold border-success");
                                if (random > 20) {
                                    toastr.success(`You have been rewarded: ₹${data} </br>
                                    ₹20 was debited from your balance`);
                                }
                                else if (random == 20) {
                                    toastr.warning(`You have been rewarded: ₹${data} </br>
                                    ₹20 was debited from your balance`);
                                }
                                else {
                                    toastr.error(`You have been rewarded: ₹${data} </br>
                                    ₹20 was debited from your balance`);
                                }
                            })
                            .catch(err => {

                            })
                        $("#prize").removeClass("border-dark");
                    }
                },
                error: function (xhr, status, error) {
                    toastr.error("An error occurred: " + error);
                }
            });
        }

        function performAnimation() {
            return new Promise(async (res, rej) => {
                let flag = true;
                setTimeout(() => {
                    flag = false;
                    return res()
                }, 1000)
                while (flag) {
                    $('#prize').text(`${parseInt(Math.random() * 101)}`);
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
            })
        }
    });
</script>